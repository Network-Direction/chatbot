# Teams Chat
MS Teams uses the MS Graph API  

&nbsp;<br>
## Sending Messages
    To send chat messages to teams from the chatbot, we must first be authenticated. See ms-identity.txt to understand this process  
    There is a simple function called send_chat() which will send a message to the Graph API, along with the bearer token  
    
## Talking to the Chatbot
    Users can send messages to the chatbot; This only has rudimentary functionality at this time (v0.6) for testing
    
### Change Notifications
    This requires us to subscribe to 'change notifications' for the resource (chat or group)
    When someone writes to the chat, the chatbot will get a notification via webhook
    Each resource requires its own subscription
    The subscription contains a callback URL that the webhook should be sent to
    When subscribing, GraphAPI will send authentication information to the callback URL to authenticate the subscription
    
### Refreshing
    Subscriptions are valid for up to an hour
      We select a duration while subscribing
    Before this expires, we need to request an extention
    This is done by sending a PATCH message to the API with a new renewal time

### Encrypted Webhooks
    The webhook contains the contents of the message in an encrypted format
    During the subscription process, we pass a public key to Graph API
      Message contents are encrypted with this public key
      We can decrypt the messages with our private key
    MS will create a session key and encrypt the message with that
      The session key is different for each message
    The session key is encrypted with our public key
    
## Generating Public/Private Key Pair
    A key pair can be generated by using OpenSSL

### Windows
    Install one of the packages from:
        https://slproweb.com/products/Win32OpenSSL.html
        
### Key Generation
    Generate a private key (should be 2048-bit or larger)
        openssl genrsa -out private.key 2048
        
    Generate the public key
        openssl req -new -x509 -key private.key -out publickey.pem -days 365
  


&nbsp;<br>
- - - -
## teamschat.py
### send_chat()
    Arguments: message  
        This is the text that we want to send to teams, formatted as HTML  
    Returns: None  
    Purpose:  
        (1) Reads the token from token.txt, and confirms it is valid  
        (2) Connect to the Graph API using the requests module  
        (3) Check the response, and handle 401 and 429 errors  
  

&nbsp;<br>
- - - -
## crypto.py
The private key should be a file named 'private.pem', which should be kept in the core folder
The public key should be a file named 'public.pem', which should be kept in the core folder

### rsa_decrypt()
    Arguments: 
        encrypted_symmetric_key
    Returns:
        decrypted_symmetric_key
    Purpose:
        Takes a symmetric key (encrypted) as it appears in the webhook
        Uses the private key to decrypt it
    
### validate()
    Arguments: 
        decrypted_symmetric_key
        data
        signature
    Returns:
        True or False
    Purpose:
        Creates a hash of the body of the webhook, using the symmetric key and HMAC-SHA-256
        Compare the result to the signature contained in the webhook
        Returns True if there is a match (a valid webhook)
    
### aes_decrypt()
    Arguments: 
        decrypted_symmetric_key
        data
    Returns:
        decrypted_payload
    Purpose:
        Uses the symmetric key to decrypt the message in the webhook


&nbsp;<br>
- - - -
## parse_chats.py
    Arguments: 
    Returns:
    Purpose:


&nbsp;<br>
- - - -
## smtp.py
    Used to alert someone if there's problems sending over teams  
    This is not intended to be used for regular notifications  

### send_mail()
    Arguments: message  
        The message that should be converted to an email  
    Returns: None  
    Purpose: Takes a message, and converts it to MIMEText. Then sends email using the details in config.yaml  



